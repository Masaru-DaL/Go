# 2022.11.3. Gopher塾

- remo
  - oVice的な感じ
  - Go界隈でよく使われている

- 質疑応答
  - チャットの質疑応答のところから
  - 投票もできる

- テストの種類
  - 人によるテスト
  - 自動化テスト

- テストの必要性
  - ソフトウェアの品質の担保
  - 変更に対する品質の保証
  - ドキュメントの役割

- テストの難しさ
  - どこまでテストすべきか？
    - レイヤや粒度の判断
  - うまくテストできない

- go test
  - 単体テストを行うためのコマンド
  - `_test.go`というサフィックスの付いたファイルを対象にしてテストを実行

- テスト関数
  - TestType_Methodのように書く場合が多い
  - *testing.T型を引数に取る

- テスト関数を失敗させる
  - 継続する場合
    - Error, Errorf
  - 継続しない場合
    - Fatal, Fatalf
    - Fatalを使いこなすとキレイにコードが書けるようになる

- 失敗したときに目立つ
  - 失敗した時に表示される
    - Log
    - 失敗した理由など
  - 成功した場合は細かな表示をしない
    - `go test -v`を使うと失敗した時と同じように表示されるが常用しないようにする
    - なぜオプションなのかを考える
      - 基本使わなくていいよ！

- テストのスケールを考えておく
  - テストは増えていく
    - 増えていく
    - 重くなっていく
    - 重くなってからの対応は非常に難しい
  - スケールを考えておく
    - テストの並列実行
      - Parallel
      - 並列実行可能なように作る
    - テストの分割実行
      - Songmu/gotesplit
      - テスト関数を分けて実行する

- テスティングフレームワーク
  - Testify
    - もっともよく使われる
    - 大きめ
    - 初期化からある
  - matryer/is
    - 軽量
    - 最低限しか用意されていない
  - testing + 必要なライブラリ
    - テスティングフレームワークを利用しない
    - 必要に応じてgo-cmpなどのライブラリを利用する

- ライブラリの導入とコスト
  - ライブラリは利便性が上がるだけではない
    - 導入に当たってコストが増える
      - 学習コスト
      - 複雑さの注入
      - 他のライブラリに依存するリスク
    - 利便性とコストを天秤にかけて導入を決める
    - いきなり開発が止まるかもしれない！
  - 導入後に想定されていない使い方がされる
    - 導入時のメンバーが最後までいないとか、前から使ってたから使うとかの事も往々にしてあり得てしまう
    - 提供されている機能はすべて使われる前提でいること
      - ライブラリに付随した機能は、インストールした時点で色々な機能は使おうとすれば使えてしまう
    - 使用範囲を限定したい場合は仕組みで解決
      - ラップする
      - 静的解析などで不正使用を検知
  - ライブラリが安全かなどを調べる事も大事・必要
    - Stable Version
    - 過去の脆弱性を見るなど

- go test
  - 一次フォルダが作成されている
    - go runコマンドのようにビルドして実行している
    - go test -o testのようにテストバイナリを生成できる
  - 各テストはゴールーチンで動作している
    - ゴールーチンで動く

- runtime.Goexit関数
  - ゴールーチンを終了させる関数
  - Fatalの内部で使われている
  - 多用するものでもない

- カバレッジ
  - テストがどれだけ網羅的に行われたか調べる
  - go testはCO（命令網羅）
  - -cover オプションで出力可能
  - -coverpkgオプションでカバレッジを取得するパッケージを取得できる
    - 指定しないとテストのある関数しかカバレッジに含めない

- coverprofile
  - カバレッジの情報を記録したファイル
  - ソースコードのどこを通ったかも分かる
  - -coverprofileオプションで生成可能

- カバレッジの可視化
  - go tool cover -html=cover.out

- カバレッジ取得の仕組み
  - 計測用のコードを差し込んでいる
    - go tool coverコマンドを利用している
    - 条件分岐の度に計測している
      - カウンタの増加？
    - -x -work などのオプションを知っておくだけでも違ってくる
    - きちんと追う
    - `//line`を使うとファイルの何行目を使うという事を指定できる
      - 何行目にエラーが出ているかわかるような努力？的な事も裏ではしている

- サブテスト
  - 子テストを実行する仕組み
    - サブテストを指定して実行できる
  - -run TestAB/A とするとBは実行しない、などができる

- テーブル駆動テスト
  - テストデータ（テストケース）とロジックを分ける
    - テストケースの追加が楽
    - テストケースの保守性が高い
    - サブテストと相性が良い
  - マップ vs スライス
    - マップはテストの順番がランダム
    - 名前が揃ってみやすい
    - スライスは実行順序が同じなので分かりやすい

- テストケースを簡潔に書く
  - 差分が分かりやすい
    - 何のためのテストケースなのか分かりやすい
    - 注目したいことだけが目立つ
  - 簡潔にするテクニック
    - 名前の長い定数や変数は再定義
      - 名前だけで2行いくとかは本末転倒
      - 長ければ良いというわけではない
    - 型エイリアスをうまく使う
    - デフォルト値は変数に入れるか生成関数を作る
      - 目立たないようにする
    - ヘルパー関数を活用する
